# EPIC 4: Automated Optimization Engine (Движок автоматической оптимизации)

## Context for Copilot
**Project Type:** Spring Boot 3 + Timefold Solver (OptaPlanner).
**Architecture:** Async Solver Execution (`SolverManager`).
**Integration Pattern:** 1. Controller triggers async job -> returns 202 Accepted.
2. Solver runs in background.
3. `finalBestSolutionConsumer` saves result to DB (Repository).
**Strict Rule:** Never block the HTTP thread waiting for the solution.

---

## 1. Feature Description (Функциональный блок)
Интеграция эвристического солвера **Timefold AI** для автоматической генерации расписания.
Ключевые компоненты:
* **SolverManager:** Асинхронное управление задачами оптимизации.
* **ConstraintProvider:** Реализация жестких (Hard) и мягких (Soft) правил.
* **Dual-Mode Logic:** Уникальная логика, где Зал может работать в режиме "Эксклюзив" (Группа) или "Разделяемый" (Частные уроки).

---

## 2. Technical Tasks (Технические задачи)

### [BE-14] Конфигурация Timefold Solver
* **Entity Setup:**
    * Класс `DanceSchedule` должен иметь аннотации `@PlanningSolution`.
    * Поля: `List<Lesson>`, `List<Timeslot>`, `List<Room>`, `List<Teacher>`.
    * Поле Score: `@PlanningScore HardSoftScore score`.
* **Config:**
    * В `application.yml` настроить:
        * `timefold.solver.termination.spent-limit: 60s` (Лимит времени).
        * `timefold.solver.environment-mode: NON_INTRUSIVE_FULL_ASSERT` (для отладки констрейнтов в dev-режиме).

### [BE-15] Реализация Hard Constraints (Constraint Streams)
Создать класс `DanceScheduleConstraintProvider`. Реализовать методы через `ConstraintFactory`:

1.  **Teacher Conflict (Билокация):**
    * `Lesson` A и `Lesson` B имеют одного `Teacher` и пересекающийся `Timeslot`.
    * *Penalize:* Hard Score.

2.  **Dual-Mode Room Conflict (Критическая логика):**
    * Группировать уроки по `Room` и `Timeslot`.
    * Считать суммарную вместимость:
        * Если `LessonType == GROUP` -> занимает 1.0 (или 100% capacity).
        * Если `LessonType == PRIVATE` -> занимает 0.25 (или другую долю, если определено).
    * *Penalize:* Если сумма > 1.0 (или > Room Capacity).
    * *Note:* Это покрывает и конфликт "Группа + Группа", и "Группа + Частный", и "5 Частных уроков" (переполнение).

### [BE-16] Реализация Soft Constraints
1.  **Efficiency (Минимизация простоев):**
    * Награждать (Reward) уроки, идущие подряд у одного учителя (minimize gaps).
    * Или награждать использование `Timeslot` в Prime-Time (16:00-21:00).

2.  **Fairness (Справедливость):**
    * Использовать `ConstraintCollectors.loadBalance` по учителям.
    * Цель: Минимизировать разницу в количестве часов между учителями (с учетом их `maxDailyHours`).

### [BE-17] Solver Service & Controller (Async Pattern)
1.  **SolverService:**
    * Внедрить `SolverManager<DanceSchedule, Long>`.
    * Метод `solve(Long scheduleId)`:
        ```java
        solverManager.solveBuilder()
            .withProblemId(scheduleId)
            .withProblemFinder(repository::findById)
            .withFinalBestSolutionConsumer(solution -> {
                // СОХРАНЕНИЕ В БД ПРОИСХОДИТ ЗДЕСЬ, В ФОНЕ
                lessonRepository.saveAll(solution.getLessons());
            })
            .run();
        ```
2.  **SolverController:**
    * `POST /api/solver/solve`: Запускает сервис, возвращает `SolverStatusDTO` (JobId, Status: SOLVING).
    * `GET /api/solver/status`: Вызывает `solverManager.getSolverStatus(id)`, возвращает DTO.

---

## 3. User Stories & Acceptance Criteria

### Story 1: Запуск генерации (Admin)
**Как** Администратор,
**Я хочу** нажать кнопку "Оптимизировать" и продолжить работу,
**Чтобы** не ждать окончания расчета.

* **Acceptance Criteria:**
    * UI получает ответ `202 Accepted` мгновенно.
    * Через 60 секунд статус меняется на `NOT_SOLVING`.
    * В базе данных обновляются связи `Lesson -> Timeslot` и `Lesson -> Room`.

### Story 2: Двойной режим зала (Owner)
**Как** Владелец,
**Я хочу**, чтобы система понимала, что Группа занимает весь зал, а Частные уроки могут идти параллельно,
**Чтобы** максимально использовать пространство.

* **Acceptance Criteria:**
    * Солвер **не штрафует** 2-3 частных урока в одном зале в одно время.
    * Солвер **штрафует** (Hard Constraint), если в зале стоит Группа + любой другой урок.